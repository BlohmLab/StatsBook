
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>11. Correlation vs. Causality &#8212; NSCI 801 - Quantitative Neuroscience book</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12. Reproducibility, reliability, validity" href="NSCI801_Reproducibility.html" />
    <link rel="prev" title="10. Data Neuroscience Overview" href="NSCI801_DataNeuroscience.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">NSCI 801 - Quantitative Neuroscience book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   NSCI 801 - Quantitative Neuroscience Syllabus
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Intro.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_intro_python.html">
   2. Google COLAB and Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_advanced_python.html">
   3. Advanced Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_acquisition_filters.html">
   4. Data Collection and Signal Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Descriptive_Stats-NEW.html">
   5. Descriptive Statistics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Advanced_stats.html">
   6. Advanced Statistics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Image_Processing_Proper_v2.html">
   7. Image Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Bayesian-stats.html">
   8. Bayesian statistics and hypothesis testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_ModelFitting.html">
   9. Models in Neuroscience
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_DataNeuroscience.html">
   10. Data Neuroscience Overview
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   11. Correlation vs. Causality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="NSCI801_Reproducibility.html">
   12. Reproducibility, reliability, validity
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/NSCI801_CorrelationVsCausality.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FNSCI801_CorrelationVsCausality.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/NSCI801_CorrelationVsCausality.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nsci-801-quantitative-neuroscience">
   11.1. NSCI 801 - Quantitative Neuroscience
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outline">
     11.1.1. Outline
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-s-causality">
     11.1.2. What’s causality?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#association-is-not-causality">
     11.1.3. Association is NOT causality!
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-ladder-of-causality">
     11.1.4. The ladder of causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-to-achieve-causality-randomized-controlled-trials">
     11.1.5. How to achieve causality - randomized controlled trials
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#do-randomized-controlled-trials-work-on-networks-of-neurons">
     11.1.6. Do randomized controlled trials work on networks of neurons?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recovering-connectivity-through-perturbations">
     11.1.7. Recovering connectivity through perturbations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#correlation-vs-causation">
     11.1.8. Correlation vs causation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#failure-of-correlation-in-complex-systems">
     11.1.9. Failure of correlation in complex systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-regression-to-get-at-causality">
     11.1.10. Using regression to get at causality?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-a-glm">
     11.1.11. Fitting a GLM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#omitted-variable-bias">
     11.1.12. Omitted variable bias
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#reminder">
       11.1.12.1. Reminder
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-instrumental-variables-to-get-at-causality">
     11.1.13. Using instrumental variables to get at causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-neuro-iv-example">
     11.1.14. Non-neuro IV example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-does-iv-work-practically">
     11.1.15. How does IV work practically?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#iv-estimation-using-two-stage-least-squares">
       11.1.15.1. IV estimation using two-stage least squares
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#applying-ivs-to-neural-systems">
     11.1.16. applying IVs to neural systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ivs-and-omitted-variable-bias">
     11.1.17. IVs and omitted variable bias
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-costs-of-iv-analysis">
       11.1.17.1. The costs of IV analysis
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-influence-of-instrument-strength-on-iv-performance">
     11.1.18. The influence of instrument strength on IV performance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#granger-causality">
     11.1.19. Granger causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#granger-causality-in-large-systems">
     11.1.20. Granger causality in large systems
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#notes-on-granger-causality">
       11.1.20.1. Notes on Granger Causality
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#further-readings">
     11.1.21. Further readings
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Correlation vs. Causality</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nsci-801-quantitative-neuroscience">
   11.1. NSCI 801 - Quantitative Neuroscience
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outline">
     11.1.1. Outline
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-s-causality">
     11.1.2. What’s causality?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#association-is-not-causality">
     11.1.3. Association is NOT causality!
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-ladder-of-causality">
     11.1.4. The ladder of causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-to-achieve-causality-randomized-controlled-trials">
     11.1.5. How to achieve causality - randomized controlled trials
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#do-randomized-controlled-trials-work-on-networks-of-neurons">
     11.1.6. Do randomized controlled trials work on networks of neurons?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recovering-connectivity-through-perturbations">
     11.1.7. Recovering connectivity through perturbations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#correlation-vs-causation">
     11.1.8. Correlation vs causation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#failure-of-correlation-in-complex-systems">
     11.1.9. Failure of correlation in complex systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-regression-to-get-at-causality">
     11.1.10. Using regression to get at causality?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-a-glm">
     11.1.11. Fitting a GLM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#omitted-variable-bias">
     11.1.12. Omitted variable bias
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#reminder">
       11.1.12.1. Reminder
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-instrumental-variables-to-get-at-causality">
     11.1.13. Using instrumental variables to get at causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-neuro-iv-example">
     11.1.14. Non-neuro IV example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-does-iv-work-practically">
     11.1.15. How does IV work practically?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#iv-estimation-using-two-stage-least-squares">
       11.1.15.1. IV estimation using two-stage least squares
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#applying-ivs-to-neural-systems">
     11.1.16. applying IVs to neural systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ivs-and-omitted-variable-bias">
     11.1.17. IVs and omitted variable bias
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-costs-of-iv-analysis">
       11.1.17.1. The costs of IV analysis
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-influence-of-instrument-strength-on-iv-performance">
     11.1.18. The influence of instrument strength on IV performance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#granger-causality">
     11.1.19. Granger causality
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#granger-causality-in-large-systems">
     11.1.20. Granger causality in large systems
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#notes-on-granger-causality">
       11.1.20.1. Notes on Granger Causality
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#further-readings">
     11.1.21. Further readings
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="correlation-vs-causality">
<h1><span class="section-number">11. </span>Correlation vs. Causality<a class="headerlink" href="#correlation-vs-causality" title="Permalink to this headline">¶</a></h1>
<div class="section" id="nsci-801-quantitative-neuroscience">
<h2><span class="section-number">11.1. </span>NSCI 801 - Quantitative Neuroscience<a class="headerlink" href="#nsci-801-quantitative-neuroscience" title="Permalink to this headline">¶</a></h2>
<p>Gunnar Blohm</p>
<div class="section" id="outline">
<h3><span class="section-number">11.1.1. </span>Outline<a class="headerlink" href="#outline" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>What’s causality?</p></li>
<li><p>How to achieve causality</p>
<ul>
<li><p>Randomly controlled trials (RCT)</p></li>
<li><p>Regression and omitted variable bias</p></li>
<li><p>Instrumental variables (IV)</p></li>
<li><p>Granger causality</p></li>
</ul>
</li>
<li><p>Problem of unobserved variables in high-dimensional problems</p></li>
</ul>
</div>
<div class="section" id="what-s-causality">
<h3><span class="section-number">11.1.2. </span>What’s causality?<a class="headerlink" href="#what-s-causality" title="Permalink to this headline">¶</a></h3>
<p>Wikipedia: “Causality is the influence by which one event, process, state or object (a cause) contributes to the production of another event, process, state or object (an effect), where the cause is partly responsible for the effect, and the effect is partly dependent on the cause”</p>
<p>Examples:</p>
<ul class="simple">
<li><p>caughing is a symptom of Covid. If you caugh, does it mean you have Covid?</p></li>
<li><p>Covid leads to an immune response. If you have anti-bodies (without a vaccine), does it mean you had Covid?</p></li>
<li><p>If wearing a mask reduces the risk of catching Covid, how do we know it’s indeed an effective measure?</p></li>
</ul>
<p>What is different in these examples?</p>
</div>
<div class="section" id="association-is-not-causality">
<h3><span class="section-number">11.1.3. </span>Association is NOT causality!<a class="headerlink" href="#association-is-not-causality" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>we can use association to predict what will happen if we observe something</p></li>
<li><p>but to understand <strong>why</strong> something happened or predict what would happen if we <strong>intervened</strong> we need causality!</p></li>
</ul>
<p><strong>Causality</strong> (probabilistic):  setting the value of the cause changes the probability distribution of the outcome</p>
<ul class="simple">
<li><p>Association: What is <span class="math notranslate nohighlight">\(P(y|x)\)</span>?</p></li>
<li><p>Causality: What is <span class="math notranslate nohighlight">\(P(y|do(x))\)</span>?</p></li>
</ul>
<p><strong>We cannot learn causality from passive observation! We must intervene…</strong></p>
</div>
<div class="section" id="the-ladder-of-causality">
<h3><span class="section-number">11.1.4. </span>The ladder of causality<a class="headerlink" href="#the-ladder-of-causality" title="Permalink to this headline">¶</a></h3>
<p><img alt="ladder of causality" src="_images/ladderofcausality.png" /></p>
<p>(from Pearl &amp; Mackenzie, “The book of why”)</p>
</div>
<div class="section" id="how-to-achieve-causality-randomized-controlled-trials">
<h3><span class="section-number">11.1.5. </span>How to achieve causality - randomized controlled trials<a class="headerlink" href="#how-to-achieve-causality-randomized-controlled-trials" title="Permalink to this headline">¶</a></h3>
<p>(adapted from <a class="reference external" href="https://colab.research.google.com/github/NeuromatchAcademy/course-content/blob/master/tutorials/W3D3_NetworkCausality/student/W3D3_Tutorial1.ipynb#scrollTo=Gei4lKzwvoGi">Neuromatch Academy W3D3 Tutorial 1</a>)</p>
<p>Let’s take 2 neurons. What does it mean when we say neuron <span class="math notranslate nohighlight">\(A\)</span> causes neuron <span class="math notranslate nohighlight">\(B\)</span> to fire?</p>
<p><strong>Interventional definition of causality</strong>: <span class="math notranslate nohighlight">\((A \text{ causes } B) \Leftrightarrow ( \text{ If we force }A \text { to be different, then }B\text{ changes})\)</span></p>
<p><strong>Mathematical (probabilistic) definition of causality</strong>: <span class="math notranslate nohighlight">\(\delta_{A\to B} = \mathbb{E}[B | A=1] -  \mathbb{E}[B | A=0]\)</span></p>
<ul class="simple">
<li><p>over many trials, the average causal effect <span class="math notranslate nohighlight">\(\delta_{A\to B}\)</span> of neuron <span class="math notranslate nohighlight">\(A\)</span> upon neuron <span class="math notranslate nohighlight">\(B\)</span> is the average change in neuron <span class="math notranslate nohighlight">\(B\)</span>’s activity when we set <span class="math notranslate nohighlight">\(A=1\)</span> versus when we set <span class="math notranslate nohighlight">\(A=0\)</span></p></li>
<li><p>The logic we just described is the logic of a randomized control trial (RCT). If you randomly give 100 people a drug and 100 people a placebo, the effect is the difference in outcomes.</p></li>
</ul>
<p>Let’s pretend we can perform a randomized controlled trial for two neurons. Our model will have neuron <span class="math notranslate nohighlight">\(A\)</span> synapsing on Neuron <span class="math notranslate nohighlight">\(B\)</span>:
$<span class="math notranslate nohighlight">\(B = A + \epsilon\)</span><span class="math notranslate nohighlight">\(
 where \)</span>A<span class="math notranslate nohighlight">\( and \)</span>B<span class="math notranslate nohighlight">\( represent the activities of the two neurons and \)</span>\epsilon<span class="math notranslate nohighlight">\( is standard normal noise \)</span>\epsilon\sim\mathcal{N}(0,1)$.</p>
<p>Our goal is to perturb <span class="math notranslate nohighlight">\(A\)</span> and confirm that <span class="math notranslate nohighlight">\(B\)</span> changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;numpy&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sigmoid nonlinearity element-wise on x</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): the numpy data array we want to transform</span>
<span class="sd">    Returns</span>
<span class="sd">        (np.ndarray): x with sigmoid nonlinearity applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate our nxn causal connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        random_state (int): random seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        A (np.ndarray): our 0.1 sparse connectivity matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

    <span class="c1"># set the timescale of the dynamical system to about 100 steps</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">s_vals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A_0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A_0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">s_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># _, s_val_test, _ = np.linalg.svd(A)</span>
    <span class="c1"># assert s_val_test[0] &lt; 1, &quot;largest singular value &gt;= 1&quot;</span>

    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span> <span class="nf">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualizes the connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.ndarray): the connectivity matrix of shape (n_neurons, n_neurons)</span>
<span class="sd">        ax (plt.axis): the matplotlib axis to display on</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but visualizes A.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># make up for opposite connectivity</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

    <span class="c1"># Renormalize</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>
                         <span class="n">head_width</span><span class="o">=</span><span class="mf">.15</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                         <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_perturbed_connectivity_all_neurons</span><span class="p">(</span><span class="n">perturbed_X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix of perturbations through stacked correlations.</span>

<span class="sd">    Args:</span>
<span class="sd">        perturbed_X (np.ndarray): the simulated dynamical system X of shape</span>
<span class="sd">                                  (n_neurons, timesteps)</span>

<span class="sd">    Returns:</span>
<span class="sd">        R (np.ndarray): the estimated connectivity matrix of shape</span>
<span class="sd">                        (n_neurons, n_neurons)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># select perturbations (P) and outcomes (Outs)</span>
    <span class="c1"># we perturb the system every over time step, hence the 2 in slice notation</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">perturbed_X</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Outs</span> <span class="o">=</span> <span class="n">perturbed_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># stack perturbations and outcomes into a 2n by (timesteps / 2) matrix</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">P</span><span class="p">,</span> <span class="n">Outs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># select the perturbation -&gt; outcome block of correlation matrix (upper right)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">S</span><span class="p">)[:</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">simulate_neurons_perturb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates a dynamical system for the specified number of neurons and timesteps,</span>
<span class="sd">    BUT every other timestep the activity is clamped to a random pattern of 1s and 0s</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.array): the true connectivity matrix</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The results of the simulated system.</span>
<span class="sd">        - X has shape (n_neurons, timeteps)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_neurons</span><span class="p">)</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>  <span class="c1"># we are using helper function sigmoid</span>

    <span class="k">return</span> <span class="n">X</span>


<span class="k">def</span> <span class="nf">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot the (weighted) connectivity matrix A as a heatmap</span>

<span class="sd">    Args:</span>
<span class="sd">      A (ndarray): connectivity matrix (n_neurons by n_neurons)</span>
<span class="sd">      ax: axis on which to display connectivity matrix</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
  <span class="n">lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">lim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
  <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity Strength&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                     <span class="n">labelpad</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_connectivity_graph_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot both connectivity graph and matrix side by side</span>

<span class="sd">    Args:</span>
<span class="sd">      A (ndarray): connectivity matrix (n_neurons by n_neurons)</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># we are invoking a helper function that visualizes the connectivity matrix</span>
  <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

  <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Neuron Connectivity&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot first 10 timesteps of neural activity</span>

<span class="sd">  Args:</span>
<span class="sd">    X (ndarray): neural activity (n_neurons by timesteps)</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
  <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
  <span class="n">cax1</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax1</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Timestep&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Neuron&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Simulated Neural Activity&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_true_vs_estimated_connectivity</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">true_connectivity</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Visualize true vs estimated connectivity matrices</span>

<span class="sd">  Args:</span>
<span class="sd">    estimated_connectivity (ndarray): estimated connectivity (n_neurons by n_neurons)</span>
<span class="sd">    true_connectivity (ndarray): ground-truth connectivity (n_neurons by n_neurons)</span>
<span class="sd">    selected_neuron (int or None): None if plotting all connectivity, otherwise connectivity</span>
<span class="sd">      from selected_neuron will be shown</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">selected_neuron</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">true_connectivity</span><span class="p">[:,</span> <span class="p">[</span><span class="n">selected_neuron</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">true_connectivity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;True connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Estimated connectivity&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neuron_B</span><span class="p">(</span><span class="n">activity_of_A</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Model activity of neuron B as neuron A activity + noise</span>
<span class="sd">  Args:</span>
<span class="sd">    activity_of_A (ndarray): An array of shape (T,) containing the neural activity of neuron A</span>
<span class="sd">  Returns:</span>
<span class="sd">    ndarray: activity of neuron B</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">activity_of_A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">activity_of_A</span> <span class="o">+</span> <span class="n">noise</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Neuron A activity of zeros</span>
<span class="n">A_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>

<span class="c1"># Neuron A activity of ones</span>
<span class="n">A_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>

<span class="n">diff_in_means</span> <span class="o">=</span> <span class="n">neuron_B</span><span class="p">(</span><span class="n">A_1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">neuron_B</span><span class="p">(</span><span class="n">A_0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff_in_means</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9907195190159408
</pre></div>
</div>
</div>
</div>
<p>We could run all kinds of statistics on this result and would see that it’s solid (consistently very close to 1).</p>
<p>Thus we can recover causality here <em>because</em> changing the firing of neuron <span class="math notranslate nohighlight">\(A\)</span> did affect the firing of neuron <span class="math notranslate nohighlight">\(B\)</span>.</p>
</div>
<div class="section" id="do-randomized-controlled-trials-work-on-networks-of-neurons">
<h3><span class="section-number">11.1.6. </span>Do randomized controlled trials work on networks of neurons?<a class="headerlink" href="#do-randomized-controlled-trials-work-on-networks-of-neurons" title="Permalink to this headline">¶</a></h3>
<p>Can we still estimate causal effects when the neurons are in big networks?</p>
<p>So let’s create a system with N interconnected neurons that affect each other over time. Each neuron at time <span class="math notranslate nohighlight">\(t+1\)</span> is a function of the activity of the other neurons from the previous time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>Neurons affect each other nonlinearly: each neuron’s activity at time <span class="math notranslate nohighlight">\(t+1\)</span> consists of a linearly weighted sum of all neural activities at time <span class="math notranslate nohighlight">\(t\)</span>, with added noise, passed through a nonlinearity:</p>
<div class="math notranslate nohighlight">
\[
\vec{x}_{t+1} = \sigma(A\vec{x}_t + \epsilon_t), 
\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\vec{x}_t\)</span> is an <span class="math notranslate nohighlight">\(n\)</span>-dimensional vector representing our <span class="math notranslate nohighlight">\(n\)</span>-neuron system at timestep <span class="math notranslate nohighlight">\(t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma\)</span> is a sigmoid nonlinearity</p></li>
<li><p><span class="math notranslate nohighlight">\(A\)</span> is our <span class="math notranslate nohighlight">\(n \times n\)</span> <em>causal ground truth connectivity matrix</em> (more on this later)</p></li>
<li><p><span class="math notranslate nohighlight">\(\epsilon_t\)</span> is random noise: <span class="math notranslate nohighlight">\(\epsilon_t \sim N(\vec{0}, I_n)\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\vec{x}_0\)</span> is initialized to <span class="math notranslate nohighlight">\(\vec{0}\)</span></p></li>
</ul>
<p><span class="math notranslate nohighlight">\(A\)</span> is a connectivity matrix, so the element <span class="math notranslate nohighlight">\(A_{ij}\)</span> represents the causal effect of neuron <span class="math notranslate nohighlight">\(i\)</span> on neuron <span class="math notranslate nohighlight">\(j\)</span>. In our system, neurons will receive connections from only 10% of the whole population on average.</p>
<p>So let’s first have a look at the connectivity matrix…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Initializes the system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span> <span class="c1"># we are invoking a helper function that generates our nxn causal connectivity matrix.</span>

<span class="c1"># Let&#39;s plot it!</span>
<span class="n">plot_connectivity_graph_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_15_0.png" src="_images/NSCI801_CorrelationVsCausality_15_0.png" />
</div>
</div>
<p>Now we can simulate the dynamics of the system to see how each neuron’s activity evolves over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulates a dynamical system for the specified number of neurons and timesteps.</span>
<span class="sd">    Args:</span>
<span class="sd">        A (np.array): the connectivity matrix</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        random_state (int): random seed for reproducibility</span>
<span class="sd">    Returns:</span>
<span class="sd">        - X has shape (n_neurons, timeteps). A schematic:</span>
<span class="sd">                   ___t____t+1___</span>
<span class="sd">       neuron  0  |   0    1     |</span>
<span class="sd">                  |   1    0     |</span>
<span class="sd">       neuron  i  |   0 -&gt; 1     |</span>
<span class="sd">                  |   0    0     |</span>
<span class="sd">                  |___1____0_____|</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

        <span class="c1"># Create noise vector</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">))</span>

        <span class="c1"># Update activity vector for next step</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>  <span class="c1"># we are using helper function sigmoid</span>

    <span class="k">return</span> <span class="n">X</span>


<span class="c1"># Set simulation length</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Uncomment below to test your function</span>

<span class="c1"># Simulate our dynamical system</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="n">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_17_0.png" src="_images/NSCI801_CorrelationVsCausality_17_0.png" />
</div>
</div>
</div>
<div class="section" id="recovering-connectivity-through-perturbations">
<h3><span class="section-number">11.1.7. </span>Recovering connectivity through perturbations<a class="headerlink" href="#recovering-connectivity-through-perturbations" title="Permalink to this headline">¶</a></h3>
<p>We will <em>intervene</em> in the neural activity by setting all neurons’ activity randomly to either 0 or 1 on every second time step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Simulate for 5000 timesteps.</span>

<span class="c1"># Simulate our dynamical system for the given amount of time</span>
<span class="n">X_perturbed</span> <span class="o">=</span> <span class="n">simulate_neurons_perturb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="c1"># Plot our standard versus perturbed dynamics</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">im0</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_perturbed</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>

<span class="c1"># Matplotlib boilerplate code</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax0</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax0</span><span class="p">)</span>

<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax1</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax1</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Neuron&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Timestep&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Timestep&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Standard dynamics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Perturbed dynamics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_19_0.png" src="_images/NSCI801_CorrelationVsCausality_19_0.png" />
</div>
</div>
<p>From the above perturbed dynamics, we can write a function that recovers the causal effect of a given single neuron (<code class="docutils literal notranslate"><span class="pre">selected_neuron</span></code>) upon all other neurons in the system. Remember from above you’re calculating:
$<span class="math notranslate nohighlight">\(
\color{grey}{\delta_{x^i\to x^j} \approx \frac1N \sum_i^N[x_{t+1}^j | x^i_t=1] -  \frac1N \sum_i^N[x_{t+1}^j | x^i_t=0] }
\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_perturbed_connectivity_from_single_neuron</span><span class="p">(</span><span class="n">perturbed_X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the connectivity matrix from the selected neuron using differences in means.</span>
<span class="sd">    Args:</span>
<span class="sd">        perturbed_X (np.ndarray): the perturbed dynamical system matrix of shape (n_neurons, timesteps)</span>
<span class="sd">        selected_neuron (int): the index of the neuron we want to estimate connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        estimated_connectivity (np.ndarray): estimated connectivity for the selected neuron, of shape (n_neurons,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract the perturbations of neuron 1 (every other timestep)</span>
    <span class="n">neuron_perturbations</span> <span class="o">=</span> <span class="n">perturbed_X</span><span class="p">[</span><span class="n">selected_neuron</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Extract the observed outcomes of all the neurons (every other timestep)</span>
    <span class="n">all_neuron_output</span> <span class="o">=</span> <span class="n">perturbed_X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Initialize estimated connectivity matrix</span>
    <span class="n">estimated_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

    <span class="c1"># Loop over neurons</span>
    <span class="k">for</span> <span class="n">neuron_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>

        <span class="c1"># Get this output neurons (neuron_idx) activity</span>
        <span class="n">this_neuron_output</span> <span class="o">=</span> <span class="n">all_neuron_output</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Get timesteps where the selected neuron == 0 vs == 1</span>
        <span class="n">one_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">neuron_perturbations</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">zero_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">neuron_perturbations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">difference_in_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">this_neuron_output</span><span class="p">[</span><span class="n">one_idx</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">this_neuron_output</span><span class="p">[</span><span class="n">zero_idx</span><span class="p">])</span>

        <span class="n">estimated_connectivity</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference_in_means</span>

    <span class="k">return</span> <span class="n">estimated_connectivity</span>


<span class="c1"># Initialize the system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Simulate our perturbed dynamical system</span>
<span class="n">perturbed_X</span> <span class="o">=</span> <span class="n">simulate_neurons_perturb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="c1"># Measure connectivity of neuron 1</span>
<span class="n">estimated_connectivity</span> <span class="o">=</span> <span class="n">get_perturbed_connectivity_from_single_neuron</span><span class="p">(</span><span class="n">perturbed_X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>

<span class="n">plot_true_vs_estimated_connectivity</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_21_0.png" src="_images/NSCI801_CorrelationVsCausality_21_0.png" />
</div>
</div>
<p>We can quantify how close our estimated connectivity matrix is to our true connectivity matrix by correlating them. We should see almost perfect correlation between our estimates and the true connectivity - do we?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlate true vs estimated connectivity matrix</span>
<span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="n">selected_neuron</span><span class="p">],</span> <span class="n">estimated_connectivity</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9960188025389387
</pre></div>
</div>
</div>
</div>
<p>Finally we can try to recover the whole connectivity matrix using the same strategy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Generate nxn causal connectivity matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

<span class="c1"># Simulate perturbed dynamical system</span>
<span class="n">perturbed_X</span> <span class="o">=</span> <span class="n">simulate_neurons_perturb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="c1"># Get estimated connectivity matrix</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">get_perturbed_connectivity_all_neurons</span><span class="p">(</span><span class="n">perturbed_X</span><span class="p">)</span>

<span class="c1"># Let&#39;s visualize the true connectivity and estimated connectivity together</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># we are invoking a helper function that visualizes the connectivity matrix</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;True connectivity matrix A&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">see_neurons</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># we are invoking a helper function that visualizes the connectivity matrix</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity matrix R&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_25_0.png" src="_images/NSCI801_CorrelationVsCausality_25_0.png" />
<img alt="_images/NSCI801_CorrelationVsCausality_25_1.png" src="_images/NSCI801_CorrelationVsCausality_25_1.png" />
</div>
</div>
<p>We can again calculate the correlation coefficient between the elements of the two matrices. As you can see from the cell below, we do a good job recovering the true causality of the system!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9875934043783577
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="correlation-vs-causation">
<h3><span class="section-number">11.1.8. </span>Correlation vs causation<a class="headerlink" href="#correlation-vs-causation" title="Permalink to this headline">¶</a></h3>
<p>In small systems, correlation can look like causation. Let’s attempt to recover the true connectivity matrix (A) just by correlating the neural state at each timestep with the previous state: <span class="math notranslate nohighlight">\(C=\vec{x_t}{\vec{x_{t+1}}^T}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_connectivity_from_single_neuron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the connectivity matrix from a single neuron neurons using correlations</span>
<span class="sd">    Args:</span>
<span class="sd">        X (ndarray): the matrix of activities</span>
<span class="sd">        selected_neuron (int): the index of the selected neuron</span>
<span class="sd">    Returns:</span>
<span class="sd">        estimated_connectivity (ndarray): estimated connectivity for the selected neuron, of shape (n_neurons,)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Extract the current activity of selected_neuron, t</span>
    <span class="n">current_activity</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">selected_neuron</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Extract the observed outcomes of all the neurons</span>
    <span class="n">next_activity</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># Initialize estimated connectivity matrix</span>
    <span class="n">estimated_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

    <span class="c1"># Loop through all neurons</span>
    <span class="k">for</span> <span class="n">neuron_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>

        <span class="c1"># Get the activity of neuron_idx</span>
        <span class="n">this_output_activity</span> <span class="o">=</span> <span class="n">next_activity</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span>

        <span class="c1"># Compute correlation</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">this_output_activity</span><span class="p">,</span> <span class="n">current_activity</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Store this neuron&#39;s correlation</span>
        <span class="n">estimated_connectivity</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation</span>

    <span class="k">return</span> <span class="n">estimated_connectivity</span>

<span class="c1"># Simulate a 6 neuron system for 5000 timesteps again.</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Invoke a helper function that generates our nxn causal connectivity matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

<span class="c1"># Invoke a helper function that simulates the neural activity</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

<span class="c1"># Uncomment below to test your function</span>
<span class="n">estimated_connectivity</span> <span class="o">=</span> <span class="n">compute_connectivity_from_single_neuron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>

<span class="n">plot_true_vs_estimated_connectivity</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_29_0.png" src="_images/NSCI801_CorrelationVsCausality_29_0.png" />
</div>
</div>
<p>Well, that worked! Does if work for the whole network?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_sys_corr</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function for our correlation calculations between A and R.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        random_state (int): seed for reproducibility</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to slice out</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes the connectivity matrix for the all neurons using correlations</span>

<span class="sd">    Args:</span>
<span class="sd">        X: the matrix of activities</span>

<span class="sd">    Returns:</span>
<span class="sd">        estimated_connectivity (np.ndarray): estimated connectivity for the selected neuron, of shape (n_neurons,)</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
  <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">S</span><span class="p">)[:</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">:]</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">plot_estimation_quality_vs_n_neurons</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function that calculates correlation between true and estimated connectivity</span>
<span class="sd">    matrices for each number of neurons and plots</span>

<span class="sd">    Args:</span>
<span class="sd">      number_of_neurons (list): list of different number of neurons for modeling system</span>
<span class="sd">      corr_func (function): Function for computing correlation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">corr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulating trial </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">):</span>
          <span class="n">corr</span> <span class="o">=</span> <span class="n">get_sys_corr</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
          <span class="n">corr_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span>

    <span class="n">corr_mean</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">corr_std</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">,</span> <span class="n">corr_mean</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">,</span>
                     <span class="n">corr_mean</span> <span class="o">-</span> <span class="n">corr_std</span><span class="p">,</span>
                     <span class="n">corr_mean</span> <span class="o">+</span> <span class="n">corr_std</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of neurons&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Correlation&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Similarity between A and R as a function of network size&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot the (weighted) connectivity matrix A as a heatmap</span>

<span class="sd">    Args:</span>
<span class="sd">      A (ndarray): connectivity matrix (n_neurons by n_neurons)</span>
<span class="sd">      ax: axis on which to display connectivity matrix</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
  <span class="n">lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">lim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">lim</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
  <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity Strength&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                     <span class="n">labelpad</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_true_vs_estimated_connectivity</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">true_connectivity</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Visualize true vs estimated connectivity matrices</span>

<span class="sd">  Args:</span>
<span class="sd">    estimated_connectivity (ndarray): estimated connectivity (n_neurons by n_neurons)</span>
<span class="sd">    true_connectivity (ndarray): ground-truth connectivity (n_neurons by n_neurons)</span>
<span class="sd">    selected_neuron (int or None): None if plotting all connectivity, otherwise connectivity</span>
<span class="sd">      from selected_neuron will be shown</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">selected_neuron</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">true_connectivity</span><span class="p">[:,</span> <span class="p">[</span><span class="n">selected_neuron</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">estimated_connectivity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">true_connectivity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;True connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Estimated connectivity&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;True connectivity matrix A&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">see_neurons</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity matrix R&quot;</span><span class="p">);</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation matrix of A and R:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation matrix of A and R: 0.9596667994046594
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_32_1.png" src="_images/NSCI801_CorrelationVsCausality_32_1.png" />
<img alt="_images/NSCI801_CorrelationVsCausality_32_2.png" src="_images/NSCI801_CorrelationVsCausality_32_2.png" />
</div>
</div>
<p>YES! So what is all the fuss about “correlation is NOT causation”?</p>
</div>
<div class="section" id="failure-of-correlation-in-complex-systems">
<h3><span class="section-number">11.1.9. </span>Failure of correlation in complex systems<a class="headerlink" href="#failure-of-correlation-in-complex-systems" title="Permalink to this headline">¶</a></h3>
<p>Let’s jump to a much bigger system. Instead of 6 neurons, we will now use 100 neurons. How does the estimation quality of the connectivity matrix change?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate a 100 neuron system for 5000 timesteps.</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span> 

<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation matrix of A and R:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True connectivity matrix A&quot;</span><span class="p">)</span>
<span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity matrix R&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation matrix of A and R: 0.36293298241778177
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_35_1.png" src="_images/NSCI801_CorrelationVsCausality_35_1.png" />
</div>
</div>
<p>Now <strong>this</strong> is why correlation measures cannot reliably identify causal interactions with limited data even when we observe the whole system!</p>
<p>We can plot how this method breaks down as a function of network size…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_trials</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># shorter timesteps for faster running time</span>
<span class="n">number_of_neurons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">plot_estimation_quality_vs_n_neurons</span><span class="p">(</span><span class="n">number_of_neurons</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>simulating trial 1 of 5
simulating trial 2 of 5
simulating trial 3 of 5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\Gunnar\AppData\Local\Temp/ipykernel_19712/2244436019.py:29: RuntimeWarning: invalid value encountered in true_divide
  A = A_0 / (1.01 * s_vals[0])
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>simulating trial 4 of 5
simulating trial 5 of 5
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_37_3.png" src="_images/NSCI801_CorrelationVsCausality_37_3.png" />
</div>
</div>
<p>And we can also look at how the sparsity of <span class="math notranslate nohighlight">\(A\)</span> affects the estimation of connectivity…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate our nxn causal connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        random_state (int): random seed for reproducibility</span>

<span class="sd">    Returns:</span>
<span class="sd">        A (np.ndarray): our 0.1 sparse connectivity matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">])</span>

    <span class="c1"># set the timescale of the dynamical system to about 100 steps</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">s_vals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A_0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A_0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">s_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># _, s_val_test, _ = np.linalg.svd(A)</span>
    <span class="c1"># assert s_val_test[0] &lt; 1, &quot;largest singular value &gt;= 1&quot;</span>

    <span class="k">return</span> <span class="n">A</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>       <span class="c1"># interactive display</span>

<span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">.01</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_corrs</span><span class="p">(</span><span class="n">sparsity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">timesteps</span> <span class="o">=</span> <span class="mi">2000</span>
  <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
  <span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">25</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">sparsity</span><span class="p">)</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">correlation_for_all_neurons</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
  <span class="n">corr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
  <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">plot_connectivity_matrix</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Correlation : </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2f252e8e2e8e43f0982c4747e07554bb", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</div>
<div class="section" id="using-regression-to-get-at-causality">
<h3><span class="section-number">11.1.10. </span>Using regression to get at causality?<a class="headerlink" href="#using-regression-to-get-at-causality" title="Permalink to this headline">¶</a></h3>
<p>Simple correlation failed. But what about using some common advanced (but controversial) methods that estimate causality from observational data?</p>
<ul class="simple">
<li><p>fitting a function to our data directly, instead of trying to use perturbations or correlations</p></li>
<li><p>estimate causal connectivity when there are no perturbations</p></li>
</ul>
<p>This only works of course if there are no <em>confounders</em>. <strong>A confound is any variable that affects both the outcome and your original covariate.</strong></p>
<p><strong>Controlling for a confound</strong>:
Confonds can be controlled for by adding them as covariates in a regression. But for your coefficients to be causal effects, you need three things:</p>
<ol class="simple">
<li><p><strong>All</strong> confounds are included as covariates</p></li>
<li><p>Your regression assumes the same mathematical form of how covariates relate to outcomes (linear, GLM, etc.)</p></li>
<li><p>No covariates are caused <em>by</em> both the treatment (original variable) and the outcome. These are <a class="reference external" href="https://en.wikipedia.org/wiki/Collider_(statistics)">colliders</a>; we won’t introduce it today (but Google it on your own time! Colliders are very counterintuitive.)</p></li>
</ol>
<p>In the real world it is very hard to guarantee these conditions are met. In the brain it’s even harder (as we can’t measure all neurons).</p>
</div>
<div class="section" id="fitting-a-glm">
<h3><span class="section-number">11.1.11. </span>Fitting a GLM<a class="headerlink" href="#fitting-a-glm" title="Permalink to this headline">¶</a></h3>
<p>Recall that in our system each neuron effects every other via:</p>
<div class="math notranslate nohighlight">
\[
\vec{x}_{t+1} = \sigma(A\vec{x}_t + \epsilon_t), 
\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma\)</span> is our sigmoid nonlinearity from before: <span class="math notranslate nohighlight">\(\color{grey}{\sigma(x) = \frac{1}{1 + e^{-x}}}\)</span></p>
<p>Our system is a closed system, too, so there are no omitted variables. The regression coefficients should be the causal effect. Are they?</p>
<p>We will use a regression approach to estimate the causal influence of all neurons to neuron #1. Specifically, we will use linear regression to determine the <span class="math notranslate nohighlight">\(A\)</span> in:</p>
<div class="math notranslate nohighlight">
\[
\sigma^{-1}(\vec{x}_{t+1}) = A\vec{x}_t + \epsilon_t ,
\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma^{-1}\)</span> is the inverse sigmoid transformation, also sometimes referred to as the <strong>logit</strong> transformation: <span class="math notranslate nohighlight">\(\color{grey}{\sigma^{-1}(x) = \log(\frac{x}{1-x})}\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(W\)</span> be the <span class="math notranslate nohighlight">\(\vec{x}_t\)</span> values, up to the second-to-last timestep <span class="math notranslate nohighlight">\(T-1\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
W = 
\begin{bmatrix}
\mid &amp; \mid &amp; ... &amp; \mid \\ 
\vec{x}_0  &amp; \vec{x}_1  &amp; ... &amp; \vec{x}_{T-1}  \\ 
\mid &amp; \mid &amp; ... &amp; \mid
\end{bmatrix}_{n \times (T-1)}
\end{split}\]</div>
<p>Let <span class="math notranslate nohighlight">\(Y\)</span> be the <span class="math notranslate nohighlight">\(\vec{x}_{t+1}\)</span> values for a selected neuron, indexed by <span class="math notranslate nohighlight">\(i\)</span>, starting from the second timestep up to the last timestep <span class="math notranslate nohighlight">\(T\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Y = 
\begin{bmatrix}
x_{i,1}  &amp; x_{i,2}  &amp; ... &amp; x_{i, T}  \\ 
\end{bmatrix}_{1 \times (T-1)}
\end{split}\]</div>
<p>You will then fit the following model:</p>
<div class="math notranslate nohighlight">
\[
\sigma^{-1}(Y^T) = W^TV
\]</div>
<p>where <span class="math notranslate nohighlight">\(V\)</span> is the <span class="math notranslate nohighlight">\(n \times 1\)</span> coefficient matrix of this regression, which will be the estimated connectivity matrix between the selected neuron and the rest of the neurons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">,</span> <span class="n">regression_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function for our correlation calculations between A and the V estimated</span>
<span class="sd">    from regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): number of neurons</span>
<span class="sd">        A (np.ndarray): connectivity matrix</span>
<span class="sd">        X (np.ndarray): dynamical system</span>
<span class="sd">        observed_ratio (float): the proportion of n_neurons observed, must be betweem 0 and 1.</span>
<span class="sd">        regression_args (dict): dictionary of lasso regression arguments and hyperparameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">sel_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">*</span><span class="n">observed_ratio</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>

    <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

    <span class="n">sel_V</span> <span class="o">=</span> <span class="n">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">sel_X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sel_V</span>


<span class="k">def</span> <span class="nf">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ratio_observed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualizes the connectivity matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.ndarray): the connectivity matrix of shape (n_neurons, n_neurons)</span>
<span class="sd">        ax (plt.axis): the matplotlib axis to display on</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but visualizes A.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span>
    <span class="k">if</span> <span class="n">arrows</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span>
                          <span class="n">width</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">alpha</span> <span class="o">=</span> <span class="mf">.2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ratio_observed</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">nn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">ratio_observed</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">nn</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">nn</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">nn</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">nn</span><span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unobserved&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Applies the logit (inverse sigmoid) transformation</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): the numpy data array we want to transform</span>
<span class="sd">    Returns</span>
<span class="sd">        (np.ndarray): x with logit nonlinearity applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># fit multioutput regression</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">250</span> <span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_regression_estimate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>
<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int):  a neuron index to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">neuron_idx</span><span class="p">],</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># Apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Initialize regression model with no intercept and alpha=0.01</span>
    <span class="n">regression</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Fit regression to the data</span>
    <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>

<span class="c1"># Parameters</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># the size of our system</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># the number of timesteps to take</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">neuron_idx</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>


<span class="c1"># Uncomment below to test your function</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">get_regression_estimate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regression: correlation of estimated connectivity with true connectivity: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">V</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lagged correlation of estimated connectivity with true connectivity: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_sys_corr</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="n">neuron_idx</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regression: correlation of estimated connectivity with true connectivity: 0.865
Lagged correlation of estimated connectivity with true connectivity: 0.703
</pre></div>
</div>
</div>
</div>
<p>We can see from these numbers that multiple regression is better than simple correlation for estimating connectivity.</p>
<p>(Note: As you learned last week, <em>lasso</em> a.k.a. <span class="math notranslate nohighlight">\(L_1\)</span> regularization causes the coefficients to be sparse, containing mostly zeros)</p>
</div>
<div class="section" id="omitted-variable-bias">
<h3><span class="section-number">11.1.12. </span>Omitted variable bias<a class="headerlink" href="#omitted-variable-bias" title="Permalink to this headline">¶</a></h3>
<p>Usually, we’re unable to observe the entire system.</p>
<ul class="simple">
<li><p><strong>omitted variable bias</strong> becomes a problem</p></li>
<li><p>can we still estimate causality even if we can’t control for all neurons’ activity?</p></li>
</ul>
<p>We first visualize different subsets of the connectivity matrix when we observe 75% of the neurons vs 25%.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ratio_observed</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>  <span class="c1"># the proportion of neurons observed in our system</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ratio_observed</span><span class="p">):</span>
    <span class="n">sel_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_neurons</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">% neurons observed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span>
    <span class="n">offset</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">ratio</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Visualizing subsets of the connectivity matrix&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_49_0.png" src="_images/NSCI801_CorrelationVsCausality_49_0.png" />
</div>
</div>
<p>We will first change the number of observed neurons in the network and inspect the resulting estimates of connectivity in this interactive demo. How does the estimated connectivity differ?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">reg_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fit_intercept&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.001</span>
<span class="p">}</span>

<span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span>
<span class="k">def</span> <span class="nf">plot_observed</span><span class="p">(</span><span class="n">n_observed</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
  <span class="n">to_neuron</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">sel_idx</span> <span class="o">=</span> <span class="n">n_observed</span>
  <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_observed</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_neurons</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">% neurons observed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span>
  <span class="n">offset</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

  <span class="n">see_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ratio</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
  <span class="n">corr</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span>  <span class="n">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span>
                                  <span class="n">A</span><span class="p">,</span>
                                  <span class="n">X</span><span class="p">,</span>
                                  <span class="n">ratio</span><span class="p">,</span>
                                  <span class="n">reg_args</span><span class="p">)</span>

  <span class="n">big_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">big_R</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">R</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">big_R</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">n_observed</span><span class="o">&lt;</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;k&#39;</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_observed</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;Correlation : </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;True connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cf058c86adc249c0b7897d82116c5591", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Let’s inspect a plot of the correlation between true and estimated connectivity matrices vs the percent of neurons observed over multiple trials. What is the relationship that you see between performance and the number of neurons observed?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># we&#39;ll simulate many systems for various ratios of observed neurons</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">ratio_observed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">.25</span><span class="p">,</span> <span class="mf">.12</span><span class="p">]</span>  <span class="c1"># the proportion of neurons observed in our system</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># run it this many times to get variability in our results</span>

<span class="n">reg_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fit_intercept&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.001</span>
<span class="p">}</span>

<span class="n">corr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio_observed</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>

  <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">trial</span><span class="p">)</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulating trial </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">))</span>


  <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ratio_observed</span><span class="p">):</span>
      <span class="n">result</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span>
                                    <span class="n">A</span><span class="p">,</span>
                                    <span class="n">X</span><span class="p">,</span>
                                    <span class="n">ratio</span><span class="p">,</span>
                                    <span class="n">reg_args</span><span class="p">)</span>
      <span class="n">corr_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

<span class="n">corr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">corr_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">corr_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">corr_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ratio_observed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">corr_mean</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ratio_observed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">corr_mean</span> <span class="o">-</span> <span class="n">corr_std</span><span class="p">,</span>
                    <span class="n">corr_mean</span> <span class="o">+</span> <span class="n">corr_std</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Percent of neurons observed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;connectivity matrices correlation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Performance of regression as a function of the number of neurons observed&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>simulating trial 1 of 3
simulating trial 2 of 3
simulating trial 3 of 3
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_53_1.png" src="_images/NSCI801_CorrelationVsCausality_53_1.png" />
</div>
</div>
<div class="section" id="reminder">
<h4><span class="section-number">11.1.12.1. </span>Reminder<a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>in the brain we only observe a VERY small portion of neurons / voxels</p></li>
<li><p>the above approach is similar to “dynamic causal modeling (DCM)”</p></li>
</ul>
<p><strong>Take-home message</strong>: putting <em>causal</em> in the name does NOT make it causal…</p>
</div>
</div>
<div class="section" id="using-instrumental-variables-to-get-at-causality">
<h3><span class="section-number">11.1.13. </span>Using instrumental variables to get at causality<a class="headerlink" href="#using-instrumental-variables-to-get-at-causality" title="Permalink to this headline">¶</a></h3>
<p>If there is randomness naturally occurring in the system <em>that we can observe</em>, this in effect becomes the perturbations we can use to recover causal effects. This is called an <strong>instrumental variable</strong>. At high level, an instrumental variable must</p>
<ol class="simple">
<li><p>be observable</p></li>
<li><p>affect a covariate you care about</p></li>
<li><p><strong>not</strong> effect the outcome, except through the covariate</p></li>
</ol>
<p>It’s rare to find these things in the wild, but when you do it’s very powerful.</p>
</div>
<div class="section" id="non-neuro-iv-example">
<h3><span class="section-number">11.1.14. </span>Non-neuro IV example<a class="headerlink" href="#non-neuro-iv-example" title="Permalink to this headline">¶</a></h3>
<p>There is a negative correlation between X and Y, e.g. imagine</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span>: our tobacco tax <strong>instrument</strong>, which only affects an individual’s tendency to smoke while pregnant within our system</p></li>
<li><p><span class="math notranslate nohighlight">\(X_{\text{smoking}}\)</span>: number of cigarettes smoked per day while pregnant, our “treatment” if this were a randomized trial</p></li>
<li><p><span class="math notranslate nohighlight">\(U_{\text{SES}}\)</span>: socioeconomic status (higher means weathier), a <strong>confounder</strong> if it is not observed</p></li>
<li><p><span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span>: child birthweight in grams, our outcome of interest</p></li>
</ul>
<p><img alt="IV" src="_images/IV.png" /></p>
<p>Let’s suppose we have the following function for our system:</p>
<p><span class="math notranslate nohighlight">\(Y_{\text{birthweight}} = 3000 + C_{\text{SES}} - 2T_{\text{smoking}},\)</span></p>
<p>with the additional fact that <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is negatively correlated with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span>.</p>
<p>The causal effect we wish to estimate is the coefficient <span class="math notranslate nohighlight">\(-2\)</span> for <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span>, which means that if a mother smokes one additional cigarette per day while pregnant her baby will be 2 grams lighter at birth.</p>
<p>So let’s look at the correlations between our variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_corr</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for formatting print statements for correlations&quot;&quot;&quot;</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="s1">&#39;taxes&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;# cigarettes&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="s1">&#39;SES status&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="s1">&#39;birth weight&#39;</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">): </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">text_dict</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="n">text_dict</span><span class="p">[</span><span class="n">v2</span><span class="p">],</span> <span class="n">corrs</span><span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="n">idx_dict</span><span class="p">[</span><span class="n">v2</span><span class="p">]]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
<span class="c1"># vars:             Z    T    C</span>
<span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>  <span class="c1"># Z</span>
                  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>  <span class="c1"># T</span>
                  <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>  <span class="c1"># C</span>
<span class="c1"># vars:  Z  T  C</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># generate some data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">covar</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="c1"># generate Y from our equation above</span>
<span class="n">Y</span> <span class="o">=</span> <span class="mi">3000</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]]))</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]]]</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]]]</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]]]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx_dict</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]]]</span>

<span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="n">print_corr</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation between C and T (SES status and # cigarettes): -0.483
Correlation between C and Y (SES status and birth weight): 0.740
</pre></div>
</div>
</div>
</div>
<p>We see what is exactly represented in our graph above:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is correlated with both <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> and <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span></p></li>
<li><p>thus <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> is a potential confounder if not included in our analysis</p></li>
</ul>
<p>Let’s say that it is difficult to observe and quantify <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>, so we do not have it available to regress against. This is another example of the <strong>omitted variable bias</strong> we saw above.</p>
<p>What about <span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span>? Does it satisfy conditions 1, 2, and 3 of an instrument?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Condition 2?&quot;</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Condition 3?&quot;</span><span class="p">)</span>
<span class="n">print_corr</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">corrs</span><span class="p">,</span> <span class="n">idx_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Condition 2?
Correlation between Z and T (taxes and # cigarettes): 0.519
Condition 3?
Correlation between Z and C (taxes and SES status): 0.009
</pre></div>
</div>
</div>
</div>
<p>Perfect! We see that <span class="math notranslate nohighlight">\(Z_{\text{taxes}}\)</span> is correlated with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (#2) but is uncorrelated with <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> (#3).  <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> is also observable (#1), so we’ve satisfied our three criteria for an instrument:</p>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> is observable</p></li>
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> affects <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> doesn’t affect <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span> except through <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (ie <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> doesn’t affect or is affected by <span class="math notranslate nohighlight">\(C_\text{SES}\)</span>)</p></li>
</ol>
</div>
<div class="section" id="how-does-iv-work-practically">
<h3><span class="section-number">11.1.15. </span>How does IV work practically?<a class="headerlink" href="#how-does-iv-work-practically" title="Permalink to this headline">¶</a></h3>
<p>The easiest way to imagine IV is that the instrument is <strong>an observable source of “randomness”</strong> that affects the treatment. In this way it’s similar to the interventions we talked about earlier (randomized controlled trials).</p>
<p>But how do you actually use the instrument? The key is that we need to extract <strong>the component of the treatment that is due only to the effect of the instrument</strong>. We will call this component <span class="math notranslate nohighlight">\(\hat{T}\)</span>.
$<span class="math notranslate nohighlight">\(
\hat{T}\leftarrow \text{The unconfounded component of }T
\)</span><span class="math notranslate nohighlight">\(
Getting \)</span>\hat{T}<span class="math notranslate nohighlight">\( is fairly simple. It is simply the predicted value of \)</span>T<span class="math notranslate nohighlight">\( found in a regression that has only the instrument \)</span>Z$ as input.</p>
<p>Once we have the unconfounded component in hand, getting the causal effect is as easy as regressing the outcome on <span class="math notranslate nohighlight">\(\hat{T}\)</span>.</p>
<div class="section" id="iv-estimation-using-two-stage-least-squares">
<h4><span class="section-number">11.1.15.1. </span>IV estimation using two-stage least squares<a class="headerlink" href="#iv-estimation-using-two-stage-least-squares" title="Permalink to this headline">¶</a></h4>
<p>The fundamental technique for instrumental variable estimation is <strong>two-stage least squares</strong>.</p>
<p>We run two regressions:</p>
<ol class="simple">
<li><p>The first stage gets  <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> by regressing <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> on <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span>, fitting the parameter <span class="math notranslate nohighlight">\(\hat{\alpha}\)</span>:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[
\hat{T}_{\text{smoking}} = \hat{\alpha} Z_\text{taxes}
\]</div>
<ol class="simple">
<li><p>The second stage then regresses <span class="math notranslate nohighlight">\(Y_{\text{birthweight}}\)</span> on <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> to obtain an estimate <span class="math notranslate nohighlight">\(\hat{\beta}\)</span> of the causal effect:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[
\hat{Y}_{\text{birthweight}} = \hat{\beta} \hat{T}_{\text{smoking}} 
\]</div>
<p>The first stage estimates the <strong>unconfounded component</strong> of <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> (ie, unaffected by the confounder <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>), as we discussed above.</p>
<p>Then, the second stage uses this unconfounded component <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span> to estimate the effect of smoking on <span class="math notranslate nohighlight">\(\hat{Y}_{\text{birthweight}}\)</span>.</p>
<p>Let’s run the regression of <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> on <span class="math notranslate nohighlight">\(Z_\text{taxes}\)</span> to compute <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span>. We will then check whether our estimate is still confounded with <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span> by comparing the correlation of <span class="math notranslate nohighlight">\(C_{\text{SES}}\)</span>  with <span class="math notranslate nohighlight">\(T_{\text{smoking}}\)</span> vs <span class="math notranslate nohighlight">\(\hat{T}_{\text{smoking}}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Lasso</span>

<span class="k">def</span> <span class="nf">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates T_hat as the first stage of a two-stage least squares.</span>
<span class="sd">    Args:</span>
<span class="sd">        T (np.ndarray): our observed, possibly confounded, treatment of shape (n, 1)</span>
<span class="sd">        Z (np.ndarray): our observed instruments of shape (n, 1)</span>
<span class="sd">    Returns</span>
<span class="sd">        T_hat (np.ndarray): our estimate of the unconfounded portion of T</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage1</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Fit linear regression model</span>
    <span class="n">stage1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># Predict T_hat using linear regression model</span>
    <span class="n">T_hat</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">T_hat</span>

<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

<span class="n">T_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">T_hat_C_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">T_hat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation between T and C: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_C_corr</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation between T_hat and C: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T_hat_C_corr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation between T and C: -0.483
Correlation between T_hat and C: 0.009
</pre></div>
</div>
</div>
</div>
<p>Now let’s implement the second stage!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates a scalar causal effect from 2-stage least squares regression using</span>
<span class="sd">    an instrument.</span>
<span class="sd">    Args:</span>
<span class="sd">        T_hat (np.ndarray): the output of the first stage regression</span>
<span class="sd">        Y (np.ndarray): our observed response (n, 1)</span>
<span class="sd">    Returns:</span>
<span class="sd">        beta (float): the estimated causal effect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize linear regression model</span>
    <span class="n">stage2</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Fit model to data</span>
    <span class="n">stage2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stage2</span><span class="o">.</span><span class="n">coef_</span>

<span class="n">T_hat</span> <span class="o">=</span> <span class="n">fit_first_stage</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">fit_second_stage</span><span class="p">(</span><span class="n">T_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimated causal effect is: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimated causal effect is: -1.984
</pre></div>
</div>
</div>
</div>
<p>This is quite close to the true causal effect of −2!</p>
</div>
</div>
<div class="section" id="applying-ivs-to-neural-systems">
<h3><span class="section-number">11.1.16. </span>applying IVs to neural systems<a class="headerlink" href="#applying-ivs-to-neural-systems" title="Permalink to this headline">¶</a></h3>
<p>Now, say we have the neural system we have been simulating, except with an additional variable <span class="math notranslate nohighlight">\(\vec{z}\)</span>. This will be our instrumental variable.</p>
<p>We treat <span class="math notranslate nohighlight">\(\vec{z}\)</span> as a source of noise in the dynamics of our neurons:</p>
<div class="math notranslate nohighlight">
\[
\vec{x}_{t+1} = \sigma(A\vec{x}_t + \eta \vec{z}_{t+1} + \epsilon_t)
\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\eta\)</span> is what we’ll call the “strength” of our IV</p></li>
<li><p><span class="math notranslate nohighlight">\(\vec{z}_t\)</span> is a random binary variable, <span class="math notranslate nohighlight">\(\vec{z}_t \sim Bernoulli(0.5)\)</span></p></li>
</ul>
<p>Remember that for each neuron <span class="math notranslate nohighlight">\(i\)</span>, we are trying to figure out whether <span class="math notranslate nohighlight">\(i\)</span> is connected to (causally affects) the other neurons in our system <em>at the next time step</em>. So for timestep <span class="math notranslate nohighlight">\(t\)</span>, we want to determine whether <span class="math notranslate nohighlight">\(\vec{x}_{i,t}\)</span> affects all the other neurons at <span class="math notranslate nohighlight">\(\vec{x}_{t+1}\)</span>. For a given neuron <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(\vec{z}_{i,t}\)</span> satistfies the 3 criteria for a valid instrument.</p>
<p><strong>What could <span class="math notranslate nohighlight">\(z\)</span> be, biologically?</strong></p>
<p>Imagine <span class="math notranslate nohighlight">\(z\)</span> to be some injected current through an <em>in vivo</em> patch clamp. It affects each neuron individually, and only affects dynamics through that neuron.</p>
<p>The cool thing about IV is that you don’t have to control <span class="math notranslate nohighlight">\(z\)</span> yourself - it can be observed. So if you mess up your wiring and accidentally connect the injected voltage to an AM radio, no worries. As long as you can observe the signal the method will work.</p>
<p>So let’s modify the function that simulates the neural system, but this time make the update rule include the effect of the instrumental variable <span class="math notranslate nohighlight">\(z\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot first 10 timesteps of neural activity</span>

<span class="sd">  Args:</span>
<span class="sd">    X (ndarray): neural activity (n_neurons by timesteps)</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
  <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
  <span class="n">cax1</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax1</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Timestep&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Neuron&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Simulated Neural Activity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates a dynamical system for the specified number of neurons and timesteps.</span>
<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): the number of neurons in our system.</span>
<span class="sd">        timesteps (int): the number of timesteps to simulate our system.</span>
<span class="sd">        eta (float): the strength of the instrument</span>
<span class="sd">        random_state (int): seed for reproducibility</span>
<span class="sd">    Returns:</span>
<span class="sd">        The tuple (A,X,Z) of the connectivity matrix, simulated system, and instruments.</span>
<span class="sd">        - A has shape (n_neurons, n_neurons)</span>
<span class="sd">        - X has shape (n_neurons, timesteps)</span>
<span class="sd">        - Z has shape (n_neurons, timesteps)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

      <span class="n">IV_on_this_timestep</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

      <span class="n">X</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">IV_on_this_timestep</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span>

<span class="c1"># Parameters</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Simulate for 5000 timesteps.</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># the size of our system</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># the strength of our instrument, higher is stronger</span>


<span class="c1"># Uncomment below to test your function</span>

<span class="c1"># Simulate our dynamical system for the given amount of time</span>
<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
<span class="n">plot_neural_activity</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_73_0.png" src="_images/NSCI801_CorrelationVsCausality_73_0.png" />
</div>
</div>
<p>Now we can run the network implementation of the above 2-stage least squares procedure…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix from 2-stage least squares regression</span>
<span class="sd">    using an instrument.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        Z (np.ndarray): our observed instruments of shape (n_neurons, timesteps)</span>

<span class="sd">    Returns:</span>

<span class="sd">        V (np.ndarray): the estimated connectivity matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Stage 1: regress X on Z</span>
    <span class="n">stage1</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stage1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="n">X_hat</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

    <span class="c1"># Stage 2: regress Y on X_hatI</span>
    <span class="n">stage2</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stage2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_hat</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Get estimated effects</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stage2</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize if this worked?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IV estimated correlation: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;True connectivity matrix&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Connectivity from&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Connectivity to&#39;</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;IV estimated connectivity matrix&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Connectivity from&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IV estimated correlation: 0.916
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_77_1.png" src="_images/NSCI801_CorrelationVsCausality_77_1.png" />
</div>
</div>
<p>The IV estimates seem to perform pretty well!</p>
</div>
<div class="section" id="ivs-and-omitted-variable-bias">
<h3><span class="section-number">11.1.17. </span>IVs and omitted variable bias<a class="headerlink" href="#ivs-and-omitted-variable-bias" title="Permalink to this headline">¶</a></h3>
<p>What if we tried estimating connectivity with IV vs regression on a subset of observed neurons?</p>
<p>Which method does better with fewer observed neurons?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>


<span class="n">reg_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fit_intercept&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.001</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># fit multioutput regression</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">,</span> <span class="n">regression_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper function for our correlation calculations between A and the V estimated</span>
<span class="sd">    from regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_neurons (int): number of neurons</span>
<span class="sd">        A (np.ndarray): connectivity matrix</span>
<span class="sd">        X (np.ndarray): dynamical system</span>
<span class="sd">        observed_ratio (float): the proportion of n_neurons observed, must be betweem 0 and 1.</span>
<span class="sd">        regression_args (dict): dictionary of lasso regression arguments and hyperparameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single float correlation value representing the similarity between A and R</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">observed_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">sel_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">*</span><span class="n">observed_ratio</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>

    <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

    <span class="n">sel_V</span> <span class="o">=</span> <span class="n">get_regression_estimate_full_connectivity</span><span class="p">(</span><span class="n">sel_X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sel_V</span>


<span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span>
<span class="k">def</span> <span class="nf">plot_observed</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]):</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">sel_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">n_neurons</span><span class="p">)</span>
  <span class="n">n_observed</span> <span class="o">=</span> <span class="n">sel_idx</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
  <span class="n">offset</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;True connectivity&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

  <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>
  <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
  <span class="n">sel_Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>

  <span class="n">V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">sel_X</span><span class="p">,</span> <span class="n">sel_Z</span><span class="p">)</span>
  <span class="n">iv_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="n">big_V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">big_V</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">V</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">big_V</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">n_observed</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_neurons</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;k&#39;</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_observed</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Correlation : </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iv_corr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>


  <span class="n">reg_corr</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_regression_corr_full_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span>
                                  <span class="n">A</span><span class="p">,</span>
                                  <span class="n">X</span><span class="p">,</span>
                                  <span class="n">ratio</span><span class="p">,</span>
                                  <span class="n">reg_args</span><span class="p">)</span>


  <span class="n">big_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">big_R</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">R</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">big_R</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">n_observed</span><span class="o">&lt;</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;k&#39;</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity (IV)&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_observed</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Correlation : </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_corr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Estimated connectivity (regression)&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Connectivity to&quot;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity from&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cef16e6def914703a9751cb919e7657f", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>We can also visualize the performance of regression and IV as a function of the observed neuron ratio below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compare_iv_estimate_to_regression</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A wrapper function to compare IV and Regressor performance as a function of observed neurons</span>

<span class="sd">  Args:</span>
<span class="sd">        observed_ratio(list): a list of different observed ratios (out of the whole system)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1">#Let&#39;s compare IV estimates to our regression estimates, uncomment the code below</span>

  <span class="n">reg_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">),))</span>
  <span class="n">iv_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">),))</span>
  <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
      <span class="n">sel_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">n_neurons</span><span class="p">)</span>

      <span class="n">sel_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">sel_Z</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">sel_A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="n">sel_idx</span><span class="p">,</span> <span class="p">:</span><span class="n">sel_idx</span><span class="p">]</span>

      <span class="n">sel_reg_V</span> <span class="o">=</span> <span class="n">get_regression_estimate</span><span class="p">(</span><span class="n">sel_X</span><span class="p">)</span>
      <span class="n">reg_corrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_reg_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

      <span class="n">sel_iv_V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">sel_X</span><span class="p">,</span> <span class="n">sel_Z</span><span class="p">)</span>
      <span class="n">iv_corrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sel_A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sel_iv_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="c1"># Plotting IV vs lasso performance</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="n">reg_corrs</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="n">iv_corrs</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Connectivity matrices correlation with truth&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fraction of observed variables&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;IV and lasso performance as a function of observed neuron ratio&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Regression&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">get_regression_estimate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the connectivity matrix using lasso regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): our simulated system of shape (n_neurons, timesteps)</span>
<span class="sd">        neuron_idx (int): optionally provide a neuron idx to compute connectivity for</span>
<span class="sd">    Returns:</span>
<span class="sd">        V (np.ndarray): estimated connectivity matrix of shape (n_neurons, n_neurons).</span>
<span class="sd">                        if neuron_idx is specified, V is of shape (n_neurons,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Extract Y and W as defined above</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">neuron_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">neuron_idx</span><span class="p">],</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># apply inverse sigmoid transformation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># fit multioutput regression</span>
    <span class="n">regression</span> <span class="o">=</span> <span class="n">MultiOutputRegressor</span><span class="p">(</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">neuron_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regression</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
            <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">coef_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>

    <span class="k">return</span> <span class="n">V</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># the size of the system</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># the strength of our instrument</span>

<span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="n">observed_ratio</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>

<span class="n">compare_iv_estimate_to_regression</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
0.8
0.6
0.4
0.2
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_83_1.png" src="_images/NSCI801_CorrelationVsCausality_83_1.png" />
</div>
</div>
<p>We see that IVs handle omitted variable bias (when the instrument is strong and we have enough data).</p>
<div class="section" id="the-costs-of-iv-analysis">
<h4><span class="section-number">11.1.17.1. </span>The costs of IV analysis<a class="headerlink" href="#the-costs-of-iv-analysis" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>we need to find an appropriate and valid instrument</p></li>
<li><p>because of the 2-stage estimation process, we need strong instruments or else our standard errors will be large</p></li>
</ul>
</div>
</div>
<div class="section" id="the-influence-of-instrument-strength-on-iv-performance">
<h3><span class="section-number">11.1.18. </span>The influence of instrument strength on IV performance<a class="headerlink" href="#the-influence-of-instrument-strength-on-iv-performance" title="Permalink to this headline">¶</a></h3>
<p>Let’s explore how the strength of the instrument <span class="math notranslate nohighlight">\(\eta\)</span> affects the quality of estimates with instrumental variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_performance_vs_eta</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_data</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Plot IV estimation performance as a function of instrument strength</span>

<span class="sd">    Args:</span>
<span class="sd">      etas (list): list of instrument strengths</span>
<span class="sd">      corr_data (ndarray): n_trials x len(etas) array where each element is the correlation</span>
<span class="sd">        between true and estimated connectivity matries for that trial and</span>
<span class="sd">        instrument strength</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">corr_mean</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">corr_std</span> <span class="o">=</span> <span class="n">corr_data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_mean</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span>
              <span class="n">corr_mean</span> <span class="o">-</span> <span class="n">corr_std</span><span class="p">,</span>
              <span class="n">corr_mean</span> <span class="o">+</span> <span class="n">corr_std</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">etas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">etas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;IV performance as a function of instrument strength&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Correlation b.t. IV and true connectivity&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Strength of instrument (eta)&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Compute IV estimation performance for different instrument strengths</span>
<span class="sd">  Args:</span>
<span class="sd">    etas (list): different instrument strengths to compare</span>
<span class="sd">    n_neurons (int): number of neurons in simulation</span>
<span class="sd">    timesteps (int): number of timesteps in simulation</span>
<span class="sd">    n_trials (int): number of trials to compute</span>
<span class="sd">  Returns:</span>
<span class="sd">    ndarray: n_trials x len(etas) array where each element is the correlation</span>
<span class="sd">        between true and estimated connectivity matries for that trial and</span>
<span class="sd">        instrument strength</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Initialize corr array</span>
  <span class="n">corr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">etas</span><span class="p">)))</span>

  <span class="c1"># Loop over trials</span>
  <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">))</span>

      <span class="c1"># Loop over instrument strenghs</span>
      <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">eta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etas</span><span class="p">):</span>

          <span class="c1"># Simulate system</span>
          <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">simulate_neurons_iv</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>

          <span class="c1"># Compute IV estimate</span>
          <span class="n">iv_V</span> <span class="o">=</span> <span class="n">get_iv_estimate_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

          <span class="c1"># Compute correlation</span>
          <span class="n">corr_data</span><span class="p">[</span><span class="n">trial</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">iv_V</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">corr_data</span>

<span class="c1"># Parameters of system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">]</span>  <span class="c1"># instrument strengths to search over</span>

<span class="n">corr_data</span> <span class="o">=</span> <span class="n">instrument_strength_effect</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">)</span>
<span class="n">plot_performance_vs_eta</span><span class="p">(</span><span class="n">etas</span><span class="p">,</span> <span class="n">corr_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trial 1 of 3
Trial 2 of 3
Trial 3 of 3
</pre></div>
</div>
<img alt="_images/NSCI801_CorrelationVsCausality_87_1.png" src="_images/NSCI801_CorrelationVsCausality_87_1.png" />
</div>
</div>
</div>
<div class="section" id="granger-causality">
<h3><span class="section-number">11.1.19. </span>Granger causality<a class="headerlink" href="#granger-causality" title="Permalink to this headline">¶</a></h3>
<p>Another potential solution to temporal causation that we might consider: <a class="reference external" href="https://en.wikipedia.org/wiki/Granger_causality"><em>Granger Causality</em></a>.</p>
<p>But, like the simultaneous fitting we explored in the GLM section, this method still fails in the presence of unobserved variables.</p>
<p>We are testing whether a time series <span class="math notranslate nohighlight">\(X\)</span> Granger-causes a time series <span class="math notranslate nohighlight">\(Y\)</span> through a hypothesis test:</p>
<ul class="simple">
<li><p>the null hypothesis <span class="math notranslate nohighlight">\(H_0\)</span>: lagged values of <span class="math notranslate nohighlight">\(X\)</span> do not help predict values of <span class="math notranslate nohighlight">\(Y\)</span></p></li>
<li><p>the alternative hypothesis <span class="math notranslate nohighlight">\(H_a\)</span>: lagged values of <span class="math notranslate nohighlight">\(X\)</span> <strong>do</strong> help predict values of <span class="math notranslate nohighlight">\(Y\)</span></p></li>
</ul>
<p>Mechanically, this is accomplished by fitting autoregressive models for <span class="math notranslate nohighlight">\(y_{t}\)</span>. We fail to reject the hypothesis if none of the <span class="math notranslate nohighlight">\(x_{t-k}\)</span> terms are retained as significant in the regression. For simplicity, we will consider only one time lag. So, we have:</p>
<div class="math notranslate nohighlight">
\[
H_0: y_t = a_0 + a_1 y_{t-1} +\epsilon_t
\]</div>
<div class="math notranslate nohighlight">
\[
H_a: y_t = a_0 + a_1 y_{t-1} + b_1 x_{t-1} +\epsilon_t
\]</div>
<p>We will first evaluate Granger causality in a small system.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">grangercausalitytests</span>

<span class="k">def</span> <span class="nf">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plot granger connectivity vs true</span>

<span class="sd">  Args:</span>
<span class="sd">    A (ndarray): true connectivity (n_neurons by n_neurons)</span>
<span class="sd">    reject_null (list): outcome of granger causality, length n_neurons</span>
<span class="sd">    selecte_neuron (int): the neuron we are plotting connectivity from</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="p">[</span><span class="n">selected_neuron</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;True connectivity for neuron </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_neuron</span><span class="p">))</span>

  <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reject_null</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">selected_neuron</span><span class="p">])</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Granger causality connectivity for neuron </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_neuron</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the lag-1 granger causality of the given neuron on the other neurons in the system.</span>
<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): the matrix holding our dynamical system of shape (n_neurons, timesteps)</span>
<span class="sd">        selected_neuron (int): the index of the neuron we want to estimate granger causality for</span>
<span class="sd">        alpha (float): Bonferroni multiple comparisons correction</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tuple (reject_null, p_vals)</span>
<span class="sd">        reject_null (list): a binary list of length n_neurons whether the null was</span>
<span class="sd">            rejected for the selected neuron granger causing the other neurons</span>
<span class="sd">        p_vals (list): a list of the p-values for the corresponding Granger causality tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_lag</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">reject_null</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">target_neuron</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
        <span class="n">ts_data</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">target_neuron</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">grangercausalitytests</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">maxlag</span><span class="o">=</span><span class="n">max_lag</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Gets the p-value for the log-ratio test</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lrtest&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">p_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
        <span class="n">reject_null</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pval</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span>


<span class="c1"># Set up small system</span>
<span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span> <span class="o">=</span> <span class="n">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
<span class="n">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_91_0.png" src="_images/NSCI801_CorrelationVsCausality_91_0.png" />
</div>
</div>
<p>Looks good! Let’s also check the correlation between Granger estimates and the true connectivity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">selected_neuron</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reject_null</span><span class="p">))[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<p>When we have a small system, we correctly identify the causality of neuron 1.</p>
</div>
<div class="section" id="granger-causality-in-large-systems">
<h3><span class="section-number">11.1.20. </span>Granger causality in large systems<a class="headerlink" href="#granger-causality-in-large-systems" title="Permalink to this headline">¶</a></h3>
<p>Let’s run Granger causality on a large system with 100 neurons. Does it still work well? How does the number of timesteps matter?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_neurons</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">timesteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">selected_neuron</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">create_connectivity</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">simulate_neurons</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

<span class="c1"># get granger causality estimates</span>
<span class="n">reject_null</span><span class="p">,</span> <span class="n">p_vals</span> <span class="o">=</span> <span class="n">get_granger_causality</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
<span class="n">compare_granger_connectivity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reject_null</span><span class="p">,</span> <span class="n">selected_neuron</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/NSCI801_CorrelationVsCausality_96_0.png" src="_images/NSCI801_CorrelationVsCausality_96_0.png" />
</div>
</div>
<p>Let’s again check the correlation between the Granger estimates and the true connectivity. Are we able to recover the true connectivity well in this larger system?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">selected_neuron</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reject_null</span><span class="p">))[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.019416331902158156
</pre></div>
</div>
</div>
</div>
<div class="section" id="notes-on-granger-causality">
<h4><span class="section-number">11.1.20.1. </span>Notes on Granger Causality<a class="headerlink" href="#notes-on-granger-causality" title="Permalink to this headline">¶</a></h4>
<p>Here we considered bivariate Granger causality – for each pair of neurons A,B, does one Granger-cause the other? You might wonder whether considering more variables will help with estimation?</p>
<ul class="simple">
<li><p>Conditional Granger Causality is a technique that allows for a multivariate system, where we test whether A Granger-causes B conditional on the other variables in the system.</p></li>
<li><p>Even after controlling for variables in the system, conditional Granger causality will also perform poorly as our system gets larger. Plus, measuring the additional variables to condition on may be infeasible in practical applications, which would introduce omitted variable bias as we saw in the regression exercise.</p></li>
</ul>
<p>One takeaway here is that as our estimation procedures become more sophisticated, they also become more difficult to interpret. We always need to understand the methods and the assumptions that are made.</p>
</div>
</div>
<div class="section" id="further-readings">
<h3><span class="section-number">11.1.21. </span>Further readings<a class="headerlink" href="#further-readings" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://bayes.cs.ucla.edu/WHY/">“the book of why” (Pearl &amp; Mackenzie, 2018)</a></p></li>
<li><p><a class="reference external" href="http://bayes.cs.ucla.edu/BOOK-2K/">“Causality” (Pearl, 2009)</a></p></li>
<li><p><a class="reference external" href="https://mfr.ca-1.osf.io/render?url=https://osf.io/5kbrs/?direct%26mode=render%26action=download%26mode=render">more suggested readings from NMA…</a></p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="NSCI801_DataNeuroscience.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">10. </span>Data Neuroscience Overview</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="NSCI801_Reproducibility.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">12. </span>Reproducibility, reliability, validity</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Gunnar Blohm, Joe Nashed<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>